# Epic 1: Configuration & Database Setup

## Goal

Set up configuration management and database schema with Drizzle ORM.

## Prerequisites

- Project has been initialized following SETUP.md
- All dependencies are installed
- TypeScript, Prettier, ESLint configured

## Tasks

### Configuration Management

Create a configuration module that loads all settings from environment variables.

**Requirements:**

- Use `import "dotenv/config"` at the top to load .env file
- Export a typed config object with all application settings
- Provide sensible defaults for all values
- Configuration should include:
  - Database path (default: `./data/polymarket.db`)
  - Polymarket API URL (default: `https://api.polymarket.com`)

**Example structure:**

```typescript
import "dotenv/config";

export const config = {
  database: {
    path: process.env.DB_PATH || "./data/polymarket.db",
  },
  polymarket: {
    apiUrl: process.env.POLYMARKET_API_URL || "https://api.polymarket.com",
  },
};
```

### Update .env.example

Ensure `.env.example` has comprehensive documentation:

```bash
# Database Configuration
# Path to SQLite database file
DB_PATH=./data/polymarket.db

# Polymarket API Configuration
# Base URL for Polymarket API
POLYMARKET_API_URL=https://api.polymarket.com

# Optional: API Key if required by Polymarket
# POLYMARKET_API_KEY=your_api_key_here
```

### Database Schema with Drizzle

Define the complete database schema using Drizzle ORM.

**snapshots table:**

- `id`: integer, primary key, auto-increment
- `wallet`: text, not null
- `snapshot_data`: text (stored as JSON), not null
- `timestamp`: text (ISO 8601 format), not null

**events table:**

- `id`: text (UUID), primary key
- `wallet`: text, not null
- `event_type`: text, not null
- `market_id`: text, not null
- `market_title`: text, not null
- `snapshot_id`: integer, not null, foreign key to `snapshots.id`
- `prev_yes_shares`: real, nullable
- `prev_no_shares`: real, nullable
- `prev_yes_avg_price`: real, nullable
- `prev_no_avg_price`: real, nullable
- `curr_yes_shares`: real, nullable
- `curr_no_shares`: real, nullable
- `curr_yes_avg_price`: real, nullable
- `curr_no_avg_price`: real, nullable
- `resolved_outcome`: text, nullable
- `pnl`: real, nullable

**Implementation notes:**

- Use `sqliteTable` from `drizzle-orm/sqlite-core`
- Define proper types for each column
- Set up foreign key relationship from events to snapshots
- Store snapshot data as JSON using `{ mode: 'json' }`

### Database Migration

Create initial migration to set up the database:

- Run `npx drizzle-kit generate` to create migration files
- The migration should create both tables with proper schema

### Database Connection

Create a database connection utility:

- Initialize better-sqlite3 database connection
- Create Drizzle database instance
- Export typed database client
- Ensure database file and directory are created if they don't exist

### Logging Utility

Create a simple logging utility:

- Support log levels: info, warn, error, debug
- Use chalk for colored output:
  - Info: cyan
  - Warn: yellow
  - Error: red
  - Debug: gray
- Format: `[timestamp] [LEVEL] message`
- Export logger functions: `logger.info()`, `logger.warn()`, `logger.error()`, `logger.debug()`

## Acceptance Criteria

- [ ] Configuration module loads from .env file
- [ ] All config values have sensible defaults
- [ ] .env.example is comprehensive with comments
- [ ] Database schema is fully defined with Drizzle
- [ ] Both tables (snapshots, events) are created correctly
- [ ] Foreign key relationship exists from events to snapshots
- [ ] Database connection can be established successfully
- [ ] Logging outputs colored messages to console
- [ ] Can run `npx drizzle-kit generate` without errors
- [ ] Database file is created in correct location

## Testing

- Verify config loads correctly from .env
- Verify config uses defaults when .env values missing
- Test database connection establishes successfully
- Verify both tables exist in database after migration
- Test logger outputs with different log levels

## Files to Create/Modify

Suggested files (organize as you prefer):

- Configuration module
- Database schema definition
- Database client/connection
- Logger utility
- Migration files (generated by drizzle-kit)
